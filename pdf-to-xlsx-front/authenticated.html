<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- ===== HEAD SEO DE BASE ===== -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- TITRE -->
    <title>Mon Compte - Convertisseur de Relevés PDF Excel</title>

    <!-- META DESCRIPTION -->
    <meta name="description" content="Tableau de bord utilisateur - Gérez vos conversions de relevés PDF en Excel, consultez vos crédits et votre historique." />

    <!-- CANONICAL -->
    <link rel="canonical" href="https://convertir-releve-compte-pdf-excel.com/authenticated.html" />

    <!-- FAVICONS & PWA -->
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#6366f1" />

    <!-- ROBOTS - No index pour les pages privées -->
    <meta name="robots" content="noindex, nofollow" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            padding: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: #6366f1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            font-weight: bold;
        }

        .nav {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .nav-link:hover {
            opacity: 1;
        }

        .user-menu {
            display: flex;
            gap: 20px;
            align-items: center;
            color: white;
        }

        .user-greeting {
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Main Content */
        .main-content {
            padding: 40px 0 80px;
            color: white;
        }

        .page-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 40px;
            text-align: center;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #a5b4fc;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 24px;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Credit Card */
        .credit-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .credit-balance {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .credit-number {
            font-size: 28px;
            font-weight: 700;
        }

        .credit-label {
            font-size: 14px;
            opacity: 0.8;
        }

        .btn-primary {
            background: #6366f1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: #5855eb;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* History Table */
        .history-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .history-table th {
            color: #a5b4fc;
            font-weight: 600;
            font-size: 14px;
        }

        .history-table td {
            color: white;
            font-size: 14px;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Messages */
        .message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #10b981;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .hidden {
            display: none;
        }

        /* Auth Loading */
        .auth-loading {
            text-align: center;
            padding: 40px;
        }

        /* Subscription Info */
        .subscription-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .subscription-info h4 {
            color: #10b981;
            margin-bottom: 10px;
        }

        .subscription-info p {
            font-size: 14px;
            color: white;
            opacity: 0.9;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            position: relative;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #333;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: #666;
            font-size: 16px;
        }

        /* Pricing Plans */
        .pricing-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .pricing-plan {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            position: relative;
            transition: all 0.3s ease;
            background: white;
        }

        .pricing-plan:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);
        }

        .pricing-plan.featured {
            border-color: #6366f1;
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
        }

        .plan-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #6366f1;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .plan-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .plan-name {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .plan-price {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 5px;
        }

        .price {
            font-size: 32px;
            font-weight: 700;
            color: #6366f1;
        }

        .period {
            font-size: 14px;
            color: #666;
        }

        .plan-features {
            margin-bottom: 30px;
        }

        .plan-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .plan-features li {
            padding: 8px 0;
            color: #374151;
            font-size: 14px;
        }

        .btn-plan {
            width: 100%;
            padding: 15px 24px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-plan:hover {
            background: #e5e7eb;
        }

        .btn-plan.featured {
            background: #6366f1;
            color: white;
        }

        .btn-plan.featured:hover {
            background: #5855eb;
        }

        .btn-plan:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-plan .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .modal-footer {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .payment-info {
            color: #666;
            font-size: 14px;
            margin: 0;
        }

        /* Invoice link button */
        .invoice-link {
            background: #6366f1;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .invoice-link:hover {
            background: #5855eb;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .page-title {
                font-size: 28px;
            }

            .history-table {
                font-size: 12px;
            }

            .history-table th,
            .history-table td {
                padding: 8px;
            }

            .pricing-plans {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .modal-content {
                padding: 20px;
                margin: 20px;
            }

            .modal-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Loading -->
    <div class="auth-loading" id="authLoading">
        <div class="spinner"></div>
        <p>Vérification de l'authentification...</p>
    </div>

    <!-- Main App (hidden until auth check) -->
    <div class="hidden" id="mainApp">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <a href="/index.html" class="logo">
                        <div class="logo-icon">BC</div>
                        Convertisseur de Relevés
                    </a>
                    <nav class="nav">
                        <a href="/index.html" class="nav-link">Accueil</a>
                        <a href="#" class="nav-link">Tarifs</a>
                        <div class="user-menu">
                            <span class="user-greeting" id="userGreeting">Chargement...</span>
                            <button class="logout-btn" onclick="handleLogout()">Déconnexion</button>
                        </div>
                    </nav>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                <h1 class="page-title">Mon Tableau de Bord</h1>

                <div class="message hidden" id="message"></div>

                <!-- Dashboard Cards -->
                <div class="dashboard-grid">
                    <!-- Credits Card -->
                    <div class="dashboard-card">
                        <h3 class="card-title">
                            <span class="card-icon">💳</span>
                            Mes Crédits
                        </h3>
                        <div class="credit-info">
                            <div class="credit-balance">
                                <span class="credit-number" id="creditBalance">--</span>
                                <span class="credit-label">crédits</span>
                            </div>
                        </div>
                        <div id="subscriptionInfo" class="hidden subscription-info">
                            <h4>Abonnement Actif</h4>
                            <p id="subscriptionDetails">Chargement...</p>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn-primary" onclick="showCreditPurchaseModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M17,13H13V17H11V13H7V11H11V7H13V11H17V13Z"/>
                                </svg>
                                Acheter
                            </button>
                            <button class="btn-secondary" onclick="openBillingPortal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,8C13.1,8 14,7.1 14,6C14,4.9 13.1,4 12,4C10.9,4 10,4.9 10,6C10,7.1 10.9,8 12,8M12,10C10.9,10 10,10.9 10,12C10,13.1 10.9,14 12,14C13.1,14 14,13.1 14,12C14,10.9 13.1,10 12,10M12,16C10.9,16 10,16.9 10,18C10,19.1 10.9,20 12,20C13.1,20 14,19.1 14,18C14,16.9 13.1,16 12,16Z"/>
                                </svg>
                                Gérer
                            </button>
                        </div>
                    </div>

                    <!-- Usage Stats -->
                    <div class="dashboard-card">
                        <h3 class="card-title">
                            <span class="card-icon">📊</span>
                            Statistiques
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <div class="stat-number" id="totalConversions">--</div>
                                <div class="stat-label">Conversions totales</div>
                            </div>
                            <div>
                                <div class="stat-number" id="thisMonthConversions">--</div>
                                <div class="stat-label">Ce mois</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="dashboard-card">
                        <h3 class="card-title">
                            <span class="card-icon">🚀</span>
                            Actions Rapides
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <a href="/index.html" class="btn-primary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                </svg>
                                Nouvelle Conversion
                            </a>
                            <button class="btn-secondary" onclick="refreshData()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                                </svg>
                                Actualiser
                            </button>
                        </div>
                    </div>

                    <!-- Billing & Invoices -->
                    <div class="dashboard-card">
                        <h3 class="card-title">
                            <span class="card-icon">🧾</span>
                            Facturation
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <button class="btn-primary" onclick="loadInvoices()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                </svg>
                                Mes Factures
                            </button>
                            <div class="stat-number" id="totalSpent" style="font-size: 16px; text-align: center;">
                                -- €
                            </div>
                            <div class="stat-label" style="text-align: center;">Montant total dépensé</div>
                        </div>
                    </div>
                </div>

                <!-- Conversion History -->
                <div class="history-section">
                    <h3 class="card-title">
                        <span class="card-icon">📋</span>
                        Historique des Conversions
                    </h3>
                    
                    <div id="historyLoading" class="hidden">
                        <div class="spinner"></div>
                        Chargement de l'historique...
                    </div>

                    <div id="historyContent">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Fichier</th>
                                    <th>Type</th>
                                    <th>Statut</th>
                                    <th>Coût</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; opacity: 0.7;">
                                        Chargement de l'historique...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Invoices Section -->
                <div class="history-section hidden" id="invoicesSection">
                    <h3 class="card-title">
                        <span class="card-icon">🧾</span>
                        Mes Factures
                        <button class="btn-secondary" onclick="hideInvoices()" style="margin-left: auto; padding: 6px 12px; font-size: 12px;">
                            Masquer
                        </button>
                    </h3>
                    
                    <div id="invoicesLoading" class="hidden">
                        <div class="spinner"></div>
                        Chargement des factures...
                    </div>

                    <div id="invoicesContent">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Montant</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTableBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; opacity: 0.7;">
                                        Cliquez sur "Mes Factures" pour charger vos factures
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Credit Purchase Modal -->
    <div class="modal-overlay" id="creditPurchaseModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCreditPurchaseModal()">&times;</button>
            
            <div class="modal-header">
                <h2 class="modal-title">Acheter des Crédits</h2>
                <p class="modal-subtitle">Choisissez votre formule</p>
            </div>

            <div class="pricing-plans">
                <!-- Pay as you go Plan -->
                <div class="pricing-plan" data-plan="pay_as_you_go">
                    <div class="plan-header">
                        <h3 class="plan-name">Paiement à l'usage</h3>
                        <div class="plan-price">
                            <span class="price">20€</span>
                            <span class="period">pour 50 conversions</span>
                        </div>
                    </div>
                    <div class="plan-features">
                        <ul>
                            <li>✅ Paiement unique</li>
                            <li>✅ Pas d'engagement</li>
                            <li>✅ Crédits sans expiration</li>
                            <li>✅ Parfait pour usage occasionnel</li>
                        </ul>
                    </div>
                    <button class="btn-plan" onclick="purchaseCredits('pay_as_you_go')">
                        <div class="spinner hidden"></div>
                        <span class="btn-text">Acheter 50 conversions</span>
                    </button>
                </div>

                <!-- Monthly Subscription Plan -->
                <div class="pricing-plan featured" data-plan="monthly_400">
                    <div class="plan-badge">Recommandé</div>
                    <div class="plan-header">
                        <h3 class="plan-name">Abonnement Mensuel</h3>
                        <div class="plan-price">
                            <span class="price">30€</span>
                            <span class="period">par mois</span>
                        </div>
                    </div>
                    <div class="plan-features">
                        <ul>
                            <li>✅ 400 conversions incluses/mois</li>
                            <li>✅ Rollover des conversions non utilisées</li>
                            <li>✅ -62% d'économies vs à l'usage</li>
                            <li>✅ Support prioritaire</li>
                        </ul>
                    </div>
                    <button class="btn-plan featured" onclick="purchaseCredits('monthly_400')">
                        <div class="spinner hidden"></div>
                        <span class="btn-text">S'abonner maintenant</span>
                    </button>
                </div>
            </div>

            <div class="modal-footer">
                <p class="payment-info">
                    💳 Paiement sécurisé par Stripe • 🔒 Annulation à tout moment
                </p>
            </div>
        </div>
    </div>

    <script>
        let userBalance = null;
        let conversionHistory = [];
        let userInvoices = [];

        // Initialize the authenticated page
        async function initAuthenticatedPage() {
            console.log('🚀 Initialisation de la page authentifiée...');
            
            try {
                // Check authentication status
                const authStatus = await checkAuthStatus();
                
                if (!authStatus.isAuthenticated) {
                    console.log('❌ Utilisateur non authentifié, redirection...');
                    // Redirect to home page if not authenticated
                    window.location.href = '/index.html';
                    return;
                }

                console.log('✅ Utilisateur authentifié');
                
                // Show main app
                document.getElementById('authLoading').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Load user data
                await loadDashboardData();
                
            } catch (error) {
                console.error('❌ Erreur lors de l\'initialisation:', error);
                showMessage('Erreur lors du chargement de la page', 'error');
                
                // Fallback: redirect to home after 3 seconds
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 3000);
            }
        }

        // Check authentication status
        async function checkAuthStatus() {
            try {
                const response = await fetch('https://api.convertir-releve-compte-pdf-excel.com/api/credits/balance', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    return {
                        isAuthenticated: data.mode === 'authenticated',
                        data: data
                    };
                }
                
                return { isAuthenticated: false };
            } catch (error) {
                console.error('❌ Erreur lors de la vérification auth:', error);
                return { isAuthenticated: false };
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            console.log('📊 Chargement des données du dashboard...');
            
            try {
                // Load balance and user info
                await loadBalance();
                
                // Load conversion history
                await loadConversionHistory();
                
                // Load initial invoice stats (but not display them)
                await loadInitialInvoiceStats();
                
            } catch (error) {
                console.error('❌ Erreur lors du chargement des données:', error);
                showMessage('Erreur lors du chargement des données', 'error');
            }
        }

        // Load initial invoice statistics without displaying the full list
        async function loadInitialInvoiceStats() {
            try {
                const response = await fetch('https://api.convertir-releve-compte-pdf-excel.com/api/billing/invoices', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const invoices = data.invoices || [];
                    updateTotalSpent(invoices);
                } else {
                    document.getElementById('totalSpent').textContent = '0,00 €';
                }
            } catch (error) {
                console.error('❌ Erreur lors du chargement des stats de facturation:', error);
                document.getElementById('totalSpent').textContent = '--';
            }
        }

        // Load balance and credits info
        async function loadBalance() {
            try {
                const response = await fetch('https://api.convertir-releve-compte-pdf-excel.com/api/credits/balance', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    userBalance = data;
                    updateBalanceDisplay(data);
                } else {
                    console.error('❌ Erreur lors du chargement du balance');
                }
            } catch (error) {
                console.error('❌ Erreur réseau lors du chargement du balance:', error);
            }
        }

        // Load conversion history
        async function loadConversionHistory() {
            document.getElementById('historyLoading').classList.remove('hidden');
            
            try {
                const response = await fetch('https://api.convertir-releve-compte-pdf-excel.com/api/conversions/history?limit=20', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    conversionHistory = data.conversions || [];
                    updateHistoryDisplay(conversionHistory);
                } else {
                    console.error('❌ Erreur lors du chargement de l\'historique');
                    updateHistoryDisplay([]);
                }
            } catch (error) {
                console.error('❌ Erreur réseau lors du chargement de l\'historique:', error);
                updateHistoryDisplay([]);
            } finally {
                document.getElementById('historyLoading').classList.add('hidden');
            }
        }

        // Update balance display
        function updateBalanceDisplay(balanceData) {
            console.log('💳 Mise à jour de l\'affichage balance:', balanceData);
            
            // Update user greeting
            const userGreeting = document.getElementById('userGreeting');
            userGreeting.textContent = `Bonjour !`;
            
            // Update credit balance
            const creditBalance = document.getElementById('creditBalance');
            if (balanceData.paidCredits) {
                creditBalance.textContent = balanceData.paidCredits.balance;
            } else {
                creditBalance.textContent = '0';
            }
            
            // Show subscription info if active
            if (balanceData.subscription && balanceData.subscription.status === 'active') {
                const subscriptionInfo = document.getElementById('subscriptionInfo');
                const subscriptionDetails = document.getElementById('subscriptionDetails');
                
                subscriptionInfo.classList.remove('hidden');
                subscriptionDetails.textContent = `Plan: ${balanceData.subscription.planId} - Prochain paiement: ${new Date(balanceData.subscription.nextInvoiceAt).toLocaleDateString('fr-FR')}`;
            }
        }

        // Update history display
        function updateHistoryDisplay(history) {
            console.log('📋 Mise à jour de l\'historique:', history.length, 'conversions');
            
            const tableBody = document.getElementById('historyTableBody');
            const totalConversions = document.getElementById('totalConversions');
            const thisMonthConversions = document.getElementById('thisMonthConversions');
            
            // Update stats
            totalConversions.textContent = history.length;
            
            // Calculate this month conversions
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const thisMonthCount = history.filter(conv => {
                const convDate = new Date(conv.createdAt);
                return convDate.getMonth() === thisMonth && convDate.getFullYear() === thisYear;
            }).length;
            thisMonthConversions.textContent = thisMonthCount;
            
            // Clear table
            tableBody.innerHTML = '';
            
            if (history.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; opacity: 0.7;">
                            Aucune conversion trouvée
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Add history rows
            history.forEach(conversion => {
                const row = document.createElement('tr');
                const date = new Date(conversion.createdAt).toLocaleDateString('fr-FR');
                const fileName = conversion.metadata?.fileName || 'Fichier inconnu';
                const status = conversion.status === 'success' ? 'success' : 'failed';
                const statusText = conversion.status === 'success' ? 'Réussi' : 'Échec';
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${fileName}</td>
                    <td>${conversion.type}</td>
                    <td><span class="status-${status}">${statusText}</span></td>
                    <td>${conversion.cost || 0} crédit(s)</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Refresh data
        async function refreshData() {
            const refreshBtn = event.target;
            refreshBtn.classList.add('loading');
            
            try {
                await loadDashboardData();
                
                // If invoices section is visible, reload them too
                const invoicesSection = document.getElementById('invoicesSection');
                if (!invoicesSection.classList.contains('hidden')) {
                    await new Promise(resolve => {
                        // Simulate click on loadInvoices to reload them
                        const fakeEvent = { target: document.createElement('button') };
                        window.event = fakeEvent;
                        loadInvoices().then(resolve);
                    });
                }
                
                showMessage('Données actualisées avec succès', 'success');
            } catch (error) {
                showMessage('Erreur lors de l\'actualisation', 'error');
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        // Open billing portal
        async function openBillingPortal() {
            try {
                const response = await fetch('https://api.convertir-releve-compte-pdf-excel.com/api/billing/portal', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    window.open(data.portalUrl, '_blank');
                } else {
                    showMessage('Impossible d\'ouvrir le portail de facturation', 'error');
                }
            } catch (error) {
                console.error('❌ Erreur lors de l\'ouverture du portail:', error);
                showMessage('Erreur réseau', 'error');
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                const response = await fetch('https://api.convertir-releve-compte-pdf-excel.com/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    console.log('✅ Déconnexion réussie');
                    // Redirect to home page
                    window.location.href = '/index.html';
                } else {
                    showMessage('Erreur lors de la déconnexion', 'error');
                }
            } catch (error) {
                console.error('❌ Erreur lors de la déconnexion:', error);
                showMessage('Erreur réseau lors de la déconnexion', 'error');
            }
        }

        // Show message
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type}`;
            message.classList.remove('hidden');
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    message.classList.add('hidden');
                }, 5000);
            }
        }

        // Credit Purchase Modal Functions
        function showCreditPurchaseModal() {
            const modal = document.getElementById('creditPurchaseModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeCreditPurchaseModal() {
            const modal = document.getElementById('creditPurchaseModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Purchase credits via Stripe Checkout
        async function purchaseCredits(planId) {
            console.log('💳 Achat de crédits, plan:', planId);
            
            const button = event.target;
            const spinner = button.querySelector('.spinner');
            const btnText = button.querySelector('.btn-text');
            
            // Show loading state
            button.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = 'Préparation...';
            
            try {
                const response = await fetch('https://api.convertir-releve-compte-pdf-excel.com/api/billing/checkout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ planId: planId })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Checkout URL créée:', data.checkoutUrl);
                    
                    // Redirect to Stripe Checkout
                    window.location.href = data.checkoutUrl;
                } else {
                    const errorData = await response.json();
                    console.error('❌ Erreur lors de la création du checkout:', errorData);
                    showMessage('Impossible de créer la session de paiement', 'error');
                }
            } catch (error) {
                console.error('❌ Erreur réseau lors du checkout:', error);
                showMessage('Erreur réseau lors de la création du paiement', 'error');
            } finally {
                // Reset button state
                button.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = planId === 'monthly_400' ? 'S\'abonner maintenant' : 'Acheter 50 conversions';
            }
        }

        // Load and display invoices
        async function loadInvoices() {
            console.log('🧾 Chargement des factures...');
            
            const invoicesSection = document.getElementById('invoicesSection');
            const loadingDiv = document.getElementById('invoicesLoading');
            const loadInvoicesBtn = event.target;
            
            // Show section and loading
            invoicesSection.classList.remove('hidden');
            loadingDiv.classList.remove('hidden');
            loadInvoicesBtn.disabled = true;
            
            try {
                const response = await fetch('https://api.convertir-releve-compte-pdf-excel.com/api/billing/invoices', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    userInvoices = data.invoices || [];
                    console.log('✅ Factures chargées:', userInvoices.length);
                    updateInvoicesDisplay(userInvoices);
                    
                    // Update total spent
                    updateTotalSpent(userInvoices);
                } else {
                    console.error('❌ Erreur lors du chargement des factures');
                    updateInvoicesDisplay([]);
                }
            } catch (error) {
                console.error('❌ Erreur réseau lors du chargement des factures:', error);
                updateInvoicesDisplay([]);
            } finally {
                loadingDiv.classList.add('hidden');
                loadInvoicesBtn.disabled = false;
            }
        }

        // Update invoices display
        function updateInvoicesDisplay(invoices) {
            const tableBody = document.getElementById('invoicesTableBody');
            
            // Clear table
            tableBody.innerHTML = '';
            
            if (invoices.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; opacity: 0.7;">
                            Aucune facture trouvée
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Add invoice rows
            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                const date = new Date(invoice.created * 1000).toLocaleDateString('fr-FR');
                const amount = (invoice.amount / 100).toFixed(2);
                const statusClass = invoice.status === 'paid' ? 'success' : 'failed';
                const statusText = invoice.status === 'paid' ? 'Payé' : 'Non payé';
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${amount} ${invoice.currency.toUpperCase()}</td>
                    <td><span class="status-${statusClass}">${statusText}</span></td>
                    <td>
                        ${invoice.invoiceUrl ? `<a href="${invoice.invoiceUrl}" target="_blank" class="invoice-link">Voir</a>` : 'N/A'}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Update total spent from invoices
        function updateTotalSpent(invoices) {
            const totalSpentElement = document.getElementById('totalSpent');
            
            const totalSpent = invoices
                .filter(invoice => invoice.status === 'paid')
                .reduce((total, invoice) => total + (invoice.amount / 100), 0);
            
            totalSpentElement.textContent = `${totalSpent.toFixed(2)} €`;
        }

        // Hide invoices section
        function hideInvoices() {
            document.getElementById('invoicesSection').classList.add('hidden');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (event) => {
            const creditModal = document.getElementById('creditPurchaseModal');
            
            if (event.target === creditModal) {
                closeCreditPurchaseModal();
            }
        });

        // Handle escape key to close modals
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeCreditPurchaseModal();
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 Page authenticated.html chargée');
            initAuthenticatedPage();
        });
    </script>
</body>
</html>
